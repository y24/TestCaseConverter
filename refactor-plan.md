# app.js リファクタリング計画書

## 現状分析

### ファイル概要
- **ファイルサイズ**: 1,737行
- **主要機能**: テストケース変換アプリケーションのフロントエンド
- **問題点**: 単一ファイルに全機能が集約されており、保守性・可読性が低下

### 現状の問題点

#### 1. 構造的問題
- **巨大な単一ファイル**: 1,737行の巨大なファイルで全機能が混在
- **関数数の過多**: 約60個以上の関数が単一ファイルに存在
- **責務の混在**: 1つのファイルでUI制御、データ処理、API通信、設定管理を全て担当
- **グローバル変数の乱用**: 7個のグローバル変数が状態管理に使用

#### 2. コード品質の問題
- **重複コードの存在**: 
  - エラーハンドリング処理の重複（複数箇所で同様のtry-catch）
  - DOM操作の重複（getElementByIdの繰り返し）
  - 設定処理の重複（parseCommaSeparated、parseKeysAndIgnores等）
- **デバッグコードの混入**: 19箇所のconsole.log/warn/errorが本番コードに残存
- **マジックナンバー**: ハードコードされた数値（50ms、100ms、500ms等）
- **長い関数**: 一部の関数が100行を超える長さ

#### 3. 保守性の問題
- **関数の依存関係が不明確**: 関数間の呼び出し関係が複雑
- **設定処理の複雑性**: updateSettings関数が60行以上で複雑
- **イベントリスナーの管理**: 14箇所のaddEventListenerが散在
- **タイマー処理の管理**: 9箇所のsetTimeoutが適切に管理されていない

#### 4. パフォーマンスの問題
- **不要なDOM操作**: 頻繁なgetElementById呼び出し
- **メモリリークの可能性**: イベントリスナーの適切な削除が行われていない
- **重複した処理**: 同じ処理が複数箇所で実行される可能性

#### 5. エラーハンドリングの問題
- **一貫性のないエラー処理**: エラーメッセージの形式が統一されていない
- **エラー情報の不足**: デバッグに必要な情報が不足
- **ユーザー体験の悪化**: エラー時の適切なフィードバックが不足

#### 6. 設定管理の問題
- **設定構造の複雑性**: ネストした設定オブジェクトの管理が困難
- **設定の検証不足**: 不正な設定値の検証が不十分
- **設定の永続化**: localStorage操作が散在

#### 7. テストの問題
- **テストの困難性**: 単一ファイルのため単体テストが困難
- **モックの困難性**: 外部依存のモック化が困難
- **テストカバレッジの低下**: 複雑な関数のテストが困難

#### 8. 拡張性の問題
- **新機能追加の困難性**: 既存コードへの影響が大きい
- **機能の分離困難**: 特定機能の独立した開発が困難
- **再利用性の低さ**: 機能の再利用が困難

### 機能分類

#### 1. アプリケーション初期化・設定管理
- アプリケーション初期化 (`initializeApp`)
- 設定の読み込み・保存 (`loadDefaultSettings`, `saveSettings`)
- 設定のUI適用 (`applySettingsToUI`)
- 設定更新 (`updateSettings`)

#### 2. ファイル管理
- ファイルアップロード・ドラッグ&ドロップ
- ファイルリスト管理
- ファイル削除・一括削除
- ファイル名重複処理

#### 3. 変換処理
- 自動変換 (`autoConvert`)
- 手動変換 (`convertFiles`)
- 変換結果の処理

#### 4. プレビュー機能
- プレビュー表示 (`showPreview`)
- WYSIWYGプレビュー
- プレビューモード切り替え
- marked.js連携

#### 5. UI制御
- イベントリスナー設定
- モーダル制御
- テーマ管理
- 折りたたみセクション

#### 6. ユーティリティ
- DOM操作ヘルパー
- エラー表示
- ローディング表示
- ローカルストレージ操作

## リファクタリング方針

### 1. モジュール分割戦略

#### 1.1 コアモジュール
```
app/web/js/
├── core/
│   ├── app.js          # メインアプリケーション
│   ├── config.js       # 設定管理
│   └── state.js        # グローバル状態管理
├── modules/
│   ├── file-manager.js # ファイル管理
│   ├── converter.js    # 変換処理
│   ├── preview.js      # プレビュー機能
│   ├── ui-controller.js # UI制御
│   └── theme-manager.js # テーマ管理
├── utils/
│   ├── dom-utils.js    # DOM操作ユーティリティ
│   ├── storage-utils.js # ローカルストレージ
│   └── validation-utils.js # バリデーション
└── constants/
    └── config.js       # 定数定義
```

#### 1.2 各モジュールの責務

**core/app.js**
- アプリケーションの初期化
- モジュール間の連携
- グローバルイベント管理

**core/config.js**
- 設定の読み込み・保存
- 設定の検証
- デフォルト設定管理

**core/state.js**
- グローバル状態の管理
- 状態変更の通知
- 状態の永続化

**modules/file-manager.js**
- ファイルアップロード処理
- ファイルリスト管理
- ドラッグ&ドロップ処理

**modules/converter.js**
- 変換処理の実行
- API通信
- 変換結果の処理

**modules/preview.js**
- プレビュー表示
- WYSIWYG機能
- プレビューモード切り替え

**modules/ui-controller.js**
- UI要素の制御
- イベントリスナー管理
- モーダル制御

**modules/theme-manager.js**
- テーマ切り替え
- システムテーマ検出
- テーマ設定の永続化

### 2. 共通化対象

#### 2.1 重複コードの統合
- **エラーハンドリング**: 統一されたエラー処理関数（19箇所のconsole.log/warn/errorを統合）
- **API通信**: 共通のHTTPクライアント（autoConvertとconvertFilesの重複処理）
- **DOM操作**: 統一されたDOM操作ヘルパー（getElementByIdの重複使用）
- **設定処理**: 設定の読み書き処理の共通化（parseCommaSeparated、parseKeysAndIgnores等）
- **タイマー管理**: 統一されたタイマー管理（9箇所のsetTimeout）
- **イベント管理**: 統一されたイベントリスナー管理（14箇所のaddEventListener）

#### 2.2 削除対象
- **デバッグコード**: 19箇所のconsole.log/warn/error
- **マジックナンバー**: ハードコードされた数値（50ms、100ms、500ms等）
- **未使用の関数**: 使用されていない関数の特定と削除
- **重複した処理**: 同じ処理が複数箇所で実行されている部分
- **古いコメントアウトされたコード**: 不要なコメントアウト
- **冗長なエラーメッセージ**: 重複したエラーメッセージ処理

### 3. 実装手順

#### Phase 1: 基盤整備
1. モジュール構造の作成
2. 定数・設定の分離
3. ユーティリティ関数の分離

#### Phase 2: コア機能の分離
1. 設定管理の分離
2. 状態管理の分離
3. ファイル管理の分離

#### Phase 3: 機能モジュールの分離
1. 変換処理の分離
2. プレビュー機能の分離
3. UI制御の分離

#### Phase 4: 統合・テスト
1. モジュール間の連携確認
2. 機能テスト
3. パフォーマンステスト

### 4. 技術的改善

#### 4.1 エラーハンドリングの改善
- **統一されたエラーハンドリング**: 19箇所の散在するエラー処理を統合
- **エラーメッセージの国際化対応**: 日本語メッセージの統一
- **エラーログの構造化**: デバッグ情報の構造化
- **ユーザーフレンドリーなエラー表示**: エラー時の適切なフィードバック

#### 4.2 パフォーマンス最適化
- **イベントリスナーの最適化**: 14箇所のaddEventListenerの適切な管理
- **デバウンス処理の統一**: 9箇所のsetTimeoutの統一管理
- **メモリリークの防止**: イベントリスナーの適切な削除
- **DOM操作の最適化**: 頻繁なgetElementById呼び出しの削減
- **重複処理の排除**: 同じ処理の複数実行を防止

#### 4.3 コード品質向上
- **関数の単一責任原則**: 60個以上の関数の責務明確化
- **適切な命名規則**: 関数・変数名の統一
- **コメントの整理**: 不要なコメントの削除と有用なコメントの追加
- **マジックナンバーの排除**: ハードコードされた数値の定数化
- **長い関数の分割**: 100行を超える関数の分割

#### 4.4 設定管理の改善
- **設定構造の簡素化**: ネストした設定オブジェクトの整理
- **設定の検証強化**: 不正な設定値の検証機能追加
- **設定の永続化統一**: localStorage操作の統一
- **設定のデフォルト値管理**: デフォルト値の一元管理

### 5. 互換性の維持

#### 5.1 外部インターフェース
- HTMLからの関数呼び出し
- グローバル変数への依存
- イベントハンドラーの互換性

#### 5.2 段階的移行
- 既存機能の動作保証
- 段階的なモジュール化
- ロールバック可能な実装

## 期待される効果

### 1. 保守性の向上
- **機能ごとの分離**: 60個以上の関数を8つのモジュールに分割
- **単一責任原則**: 各モジュールが明確な責務を持つ
- **テストの容易性**: 単体テストの実装が可能
- **変更影響の局所化**: 機能変更時の影響範囲を限定

### 2. 可読性の向上
- **ファイルサイズの削減**: 1,737行から各モジュール200-300行程度に分割
- **機能の明確な分離**: 関連する機能のグループ化
- **適切なコメント・ドキュメント**: 各モジュールの責務を明確化
- **デバッグコードの削除**: 19箇所のconsole.log/warn/errorを整理

### 3. 拡張性の向上
- **新機能の追加容易性**: モジュール単位での機能追加
- **モジュール間の疎結合**: インターフェースによる疎結合
- **再利用可能なコンポーネント**: 共通機能の再利用
- **設定の柔軟性**: 設定管理の改善による柔軟な設定

### 4. パフォーマンスの向上
- **必要な機能のみの読み込み**: モジュール単位での読み込み
- **メモリ使用量の最適化**: イベントリスナーの適切な管理
- **実行速度の向上**: 重複処理の排除
- **DOM操作の最適化**: 頻繁なDOM操作の削減

### 5. 品質の向上
- **エラーハンドリングの統一**: 一貫したエラー処理
- **設定管理の改善**: 設定の検証と永続化の統一
- **コードの重複排除**: 重複コードの統合
- **マジックナンバーの排除**: 定数化による可読性向上

## リスクと対策

### 1. 実装リスク
- **リスク**: 既存機能の動作不良
- **対策**: 段階的実装とテスト

### 2. 互換性リスク
- **リスク**: HTMLとの連携不良
- **対策**: 既存インターフェースの維持

### 3. パフォーマンスリスク
- **リスク**: モジュール化によるオーバーヘッド
- **対策**: 適切なバンドリングと最適化

## 完了基準

### 1. 機能要件
- 全機能が正常に動作すること
- 既存のHTMLインターフェースとの互換性が保たれること
- ユーザー体験が向上すること

### 2. 構造要件
- ファイルサイズが適切に分割されていること（各モジュール200-300行程度）
- 8つのモジュールに適切に分割されていること
- モジュール間の依存関係が明確であること

### 3. 品質要件
- コードの重複が削除されていること
- 19箇所のデバッグコードが整理されていること
- マジックナンバーが定数化されていること
- エラーハンドリングが統一されていること

### 4. 保守性要件
- 新機能の追加が容易になっていること
- 単体テストが実装可能であること
- コードの可読性が向上していること
- ドキュメントが整備されていること

### 5. パフォーマンス要件
- メモリリークが発生しないこと
- 実行速度が向上していること
- DOM操作が最適化されていること
- イベントリスナーが適切に管理されていること

## 実装優先度

### 高優先度（Phase 1-2）
1. モジュール構造の作成
2. 設定管理の分離
3. エラーハンドリングの統一
4. デバッグコードの整理

### 中優先度（Phase 3）
1. ファイル管理の分離
2. 変換処理の分離
3. プレビュー機能の分離
4. UI制御の分離

### 低優先度（Phase 4）
1. テーマ管理の分離
2. パフォーマンス最適化
3. テストの実装
4. ドキュメントの整備
